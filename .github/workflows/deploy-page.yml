name: Deploy to Production

on:
  workflow_dispatch: {}

concurrency:
  group: "staging-deploy-${{ github.event.workflow_run.head_branch }}"
  cancel-in-progress: true

permissions:
  pages: write
  id-token: write

jobs:
  deploy:
    if: >
      github.event.workflow_run.Deploy to Staging.conclusion == 'success' &&
      github.event.workflow_run.head_branch == 'main'
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://wahba.aiopsvision.com
    steps:
      - name: Download Pages Artifact
        uses: actions/download-artifact@v4
        with:
          name: pages-${{github.event.workflow_run.head_branch}}
          path: ./_site

      - name: Add Production CNAME
        run: echo "wahba.aiopsvision.com" > ./_site/CNAME

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Deploy to Production
        uses: actions/deploy-pages@v4
        id: deployment

      - name: Show URL
        run: echo "Deployed to:${{steps.deployment.outputs.page_url}}"
